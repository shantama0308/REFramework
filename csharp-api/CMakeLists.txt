# This file is automatically generated from cmake.toml - DO NOT EDIT
# See https://github.com/build-cpp/cmkr for more information

cmake_minimum_required(VERSION 3.15)

if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
	message(FATAL_ERROR "In-tree builds are not supported. Run CMake from a separate directory: cmake -B build")
endif()

set(CMKR_ROOT_PROJECT OFF)
if(CMAKE_CURRENT_SOURCE_DIR STREQUAL CMAKE_SOURCE_DIR)
	set(CMKR_ROOT_PROJECT ON)

	# Bootstrap cmkr and automatically regenerate CMakeLists.txt
	include(cmkr.cmake OPTIONAL RESULT_VARIABLE CMKR_INCLUDE_RESULT)
	if(CMKR_INCLUDE_RESULT)
		cmkr()
	endif()

	# Enable folder support
	set_property(GLOBAL PROPERTY USE_FOLDERS ON)

	# Create a configure-time dependency on cmake.toml to improve IDE support
	configure_file(cmake.toml cmake.toml COPYONLY)
endif()

project(CSharpAPIProject
	LANGUAGES
		CXX
		C
		CSharp
)

include(CSharpUtilities)

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /MP")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MP")
set(CMAKE_CSharp_FLAGS "${CMAKE_CSHARP_FLAGS} /langversion:latest /platform:x64")

# Disable exceptions
# string(REGEX REPLACE "/EHsc" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")

set(ASMJIT_STATIC ON CACHE BOOL "" FORCE)
set(DYNAMIC_LOADER ON CACHE BOOL "" FORCE) # OpenXR
set(BUILD_TOOLS OFF CACHE BOOL "" FORCE) # DirectXTK

if ("${CMAKE_BUILD_TYPE}" MATCHES "Release")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /MT")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MT")

    # Statically compile runtime
    string(REGEX REPLACE "/MD" "/MT" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
    string(REGEX REPLACE "/MD" "/MT" CMAKE_C_FLAGS "${CMAKE_C_FLAGS}")
    string(REGEX REPLACE "/MD" "/MT" CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE}")
    string(REGEX REPLACE "/MD" "/MT" CMAKE_C_FLAGS_RELEASE "${CMAKE_C_FLAGS_RELEASE}")
    
    message(NOTICE "Building in Release mode")
endif()

set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")

set(NUGET_PACKAGES_DIR "$ENV{NUGET_PACKAGES}")

# If NUGET_PACKAGES_DIR is not set, fall back to the default location
if(NOT NUGET_PACKAGES_DIR)
    if(WIN32)
        set(DEFAULT_NUGET_PATH "$ENV{USERPROFILE}/.nuget/packages")
    else()
        set(DEFAULT_NUGET_PATH "$ENV{HOME}/.nuget/packages")
    endif()
    set(NUGET_PACKAGES_DIR ${DEFAULT_NUGET_PATH})
endif()

# Target: REFCSharpCompiler
set(REFCSharpCompiler_SOURCES
	"Compiler/Compiler.cs"
	cmake.toml
)

add_library(REFCSharpCompiler SHARED)

target_sources(REFCSharpCompiler PRIVATE ${REFCSharpCompiler_SOURCES})
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${REFCSharpCompiler_SOURCES})

set_target_properties(REFCSharpCompiler PROPERTIES
	RUNTIME_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/bin/"
	RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO
		"${CMAKE_BINARY_DIR}/bin"
	LIBRARY_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/lib"
	DOTNET_SDK
		Microsoft.NET.Sdk
	DOTNET_TARGET_FRAMEWORK
		net8.0-windows
	VS_CONFIGURATION_TYPE
		ClassLibrary
)

set(CMKR_TARGET REFCSharpCompiler)
set_target_properties(REFCSharpCompiler PROPERTIES VS_PACKAGE_REFERENCES "Microsoft.CodeAnalysis_4.9.2")

# Target: csharp-api
set(csharp-api_SOURCES
	"REFrameworkNET/API.cpp"
	"REFrameworkNET/AssemblyInfo.cpp"
	"REFrameworkNET/Callbacks.cpp"
	"REFrameworkNET/ManagedObject.cpp"
	"REFrameworkNET/Method.cpp"
	"REFrameworkNET/MethodHook.cpp"
	"REFrameworkNET/NativeObject.cpp"
	"REFrameworkNET/Plugin.cpp"
	"REFrameworkNET/PluginManager.cpp"
	"REFrameworkNET/Proxy.cpp"
	"REFrameworkNET/TDB.cpp"
	"REFrameworkNET/TypeDefinition.cpp"
	"REFrameworkNET/API.hpp"
	"REFrameworkNET/Callbacks.hpp"
	"REFrameworkNET/Field.hpp"
	"REFrameworkNET/IObject.hpp"
	"REFrameworkNET/IProxyable.hpp"
	"REFrameworkNET/InvokeRet.hpp"
	"REFrameworkNET/ManagedObject.hpp"
	"REFrameworkNET/ManagedSingleton.hpp"
	"REFrameworkNET/Method.hpp"
	"REFrameworkNET/MethodHook.hpp"
	"REFrameworkNET/MethodParameter.hpp"
	"REFrameworkNET/NativeObject.hpp"
	"REFrameworkNET/Plugin.hpp"
	"REFrameworkNET/PluginManager.hpp"
	"REFrameworkNET/Property.hpp"
	"REFrameworkNET/Proxy.hpp"
	"REFrameworkNET/TDB.hpp"
	"REFrameworkNET/TypeDefinition.hpp"
	"REFrameworkNET/TypeInfo.hpp"
	"REFrameworkNET/Utility.hpp"
	cmake.toml
)

add_library(csharp-api SHARED)

target_sources(csharp-api PRIVATE ${csharp-api_SOURCES})
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${csharp-api_SOURCES})

target_compile_features(csharp-api PUBLIC
	cxx_std_20
)

target_compile_options(csharp-api PUBLIC
	"/EHa"
	"/MD"
)

target_include_directories(csharp-api PUBLIC
	"../include/"
)

target_link_libraries(csharp-api PUBLIC
	REFCSharpCompiler
)

set_target_properties(csharp-api PROPERTIES
	OUTPUT_NAME
		REFramework.NET
	RUNTIME_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/bin/"
	RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO
		"${CMAKE_BINARY_DIR}/bin/"
	LIBRARY_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/lib/"
	COMMON_LANGUAGE_RUNTIME
		netcore
	DOTNET_TARGET_FRAMEWORK
		net8.0-windows
	VS_GLOBAL_EnableManagedPackageReferenceSupport
		true
)

set(CMKR_TARGET csharp-api)
# Copy nuget packages to the output directory
add_custom_command(
   TARGET csharp-api POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory ${NUGET_PACKAGES_DIR}/microsoft.codeanalysis.csharp/4.9.2/lib/net7.0 ${CMAKE_BINARY_DIR}/bin//
    COMMENT "Copying nuget packages"
)
add_custom_command(
   TARGET csharp-api POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory ${NUGET_PACKAGES_DIR}/microsoft.codeanalysis.common/4.9.2/lib/net7.0 ${CMAKE_BINARY_DIR}/bin//
    COMMENT "Copying nuget packages"
)
set(REFRAMEWORK_DOT_NET_ASSEMBLY_DIR "${CMAKE_BINARY_DIR}/bin")
set(REFRAMEWORK_DOT_NET_ASSEMBLY_PATH "${CMAKE_BINARY_DIR}/bin/REFramework.NET.dll")

set_target_properties(csharp-api PROPERTIES
VS_DOTNET_REFERENCE_REFCSharpCompiler
"${REFRAMEWORK_DOT_NET_ASSEMBLY_DIR}/REFCSharpCompiler.dll"
)

set_target_properties(csharp-api PROPERTIES VS_PACKAGE_REFERENCES "REFCSharpCompiler")

# Target: AssemblyGenerator
set(AssemblyGenerator_SOURCES
	"AssemblyGenerator/ClassGenerator.cs"
	"AssemblyGenerator/Generator.cs"
	"AssemblyGenerator/SyntaxTreeBuilder.cs"
	cmake.toml
)

add_library(AssemblyGenerator SHARED)

target_sources(AssemblyGenerator PRIVATE ${AssemblyGenerator_SOURCES})
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${AssemblyGenerator_SOURCES})

target_link_libraries(AssemblyGenerator PUBLIC
	csharp-api
	REFCSharpCompiler
)

set_target_properties(AssemblyGenerator PROPERTIES
	RUNTIME_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/bin/"
	RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO
		"${CMAKE_BINARY_DIR}/bin"
	LIBRARY_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/lib"
	DOTNET_SDK
		Microsoft.NET.Sdk
	DOTNET_TARGET_FRAMEWORK
		net8.0-windows
	VS_CONFIGURATION_TYPE
		ClassLibrary
)

set(CMKR_TARGET AssemblyGenerator)
set_target_properties(AssemblyGenerator PROPERTIES
VS_DOTNET_REFERENCE_REFramework.NET
"${REFRAMEWORK_DOT_NET_ASSEMBLY_PATH}"
)

# Target: CSharpAPITest
set(CSharpAPITest_SOURCES
	"test/Test/Test.cs"
	cmake.toml
)

add_library(CSharpAPITest SHARED)

target_sources(CSharpAPITest PRIVATE ${CSharpAPITest_SOURCES})
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${CSharpAPITest_SOURCES})

target_link_libraries(CSharpAPITest PUBLIC
	csharp-api
)

set_target_properties(CSharpAPITest PROPERTIES
	RUNTIME_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/bin/"
	RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO
		"${CMAKE_BINARY_DIR}/bin"
	LIBRARY_OUTPUT_DIRECTORY_RELEASE
		"${CMAKE_BINARY_DIR}/lib"
	DOTNET_SDK
		Microsoft.NET.Sdk
	DOTNET_TARGET_FRAMEWORK
		net8.0-windows
	VS_CONFIGURATION_TYPE
		ClassLibrary
)

set(CMKR_TARGET CSharpAPITest)
set_target_properties(CSharpAPITest PROPERTIES
VS_DOTNET_REFERENCE_REFramework.NET
"${REFRAMEWORK_DOT_NET_ASSEMBLY_PATH}"
)

set_target_properties(CSharpAPITest PROPERTIES
VS_DOTNET_REFERENCE_REFramework.NET._System
"${REFRAMEWORK_DOT_NET_ASSEMBLY_DIR}/REFramework.NET._System.dll"
)

set_target_properties(CSharpAPITest PROPERTIES VS_PACKAGE_REFERENCES "REFramework.NET._System")

set_target_properties(CSharpAPITest PROPERTIES
VS_DOTNET_REFERENCE_REFramework.NET.viacore
"${REFRAMEWORK_DOT_NET_ASSEMBLY_DIR}/REFramework.NET.viacore.dll"
)

set_target_properties(CSharpAPITest PROPERTIES VS_PACKAGE_REFERENCES "REFramework.NET.viacore")

set_target_properties(CSharpAPITest PROPERTIES
VS_DOTNET_REFERENCE_REFramework.NET.application
"${REFRAMEWORK_DOT_NET_ASSEMBLY_DIR}/REFramework.NET.application.dll"
)

set_target_properties(CSharpAPITest PROPERTIES VS_PACKAGE_REFERENCES "REFramework.NET.application")
